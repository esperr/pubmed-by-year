<html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8"/>
  <title>PubMed by Year</title>
  <link href="custom.css" rel="stylesheet" type="text/css">
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
  <style type="text/css">
  @font-face {
    font-family: 'Roboto';
    font-style: normal;
    font-weight: 400;
    src: url(https://fonts.gstatic.com/s/roboto/v15/Fcx7Wwv8OzT71A3E1XOAjvesZW2xOQ-xsNqO47m55DA.woff2) format('woff2');
  }
  </style>
  <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-433406-8', 'auto');
    ga('send', 'pageview');

  </script>
</head>

<!--
Designed and built by Ed Sperr (esperr@uga.edu or ed_sperr@hotmail.com)
-->
<body>
<script>
// Detecting old IE
var ua = window.navigator.userAgent;
var msie = ua.indexOf("MSIE ");
if (msie > 0) {
    var ieVer = parseInt(ua.substring(msie + 5, ua.indexOf(".", msie)));
    if (ieVer < 9) {
      alert("Sorry! PubMed by Year does not work with IE8 or below....");
    }
}
</script>
<!-- Required to convert named colors to RGB -->
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/canvg/1.4/rgbcolor.min.js"></script>
<!-- Optional if you want blur -->
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/stackblur-canvas/1.4.1/stackblur.min.js"></script>
<!-- Main canvg code -->
<script type="text/javascript" src="https://cdn.jsdelivr.net/npm/canvg/dist/browser/canvg.min.js"></script>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.2.2/jquery.min.js"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
<script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>

<div class="container">



<div id="topbanner" class="jumbotron">
  <h1>PubMed by Year</h1>
  <a id="about" class="label label-default" href="about.html">About PubMed by Year</a>
</div>


<div class="row">



<div class="col-sm-12 col-md-8 col-lg-9">
<div id="search" class="input-group input-group-lg">
  <input type="text" id="pmsearch" class="form-control">
  <span class="input-group-btn">
    <button id="runsearch" class="btn btn-primary" type="button">Search</button>
  </span>
</div>
</div>

<div class="col-sm-12 col-md-4 col-lg-3">
  <div class="panel panel-default">
    <div class="panel-heading">Year Range</div>
    <div class="panel-body">
      <div id="pickyears"></div>
    </div>
  </div>
</div>

</div><!--row-->

<!--
<div id="printable">
  <div id="printable-stuff">
  <span class="close">Ã—</span>
  </div>
</div>
-->
<div class="row">
<div id="left" class="col-sm-12 col-md-12 col-lg-12">
<div id="results">
<div id="splash" class="panel panel-default splash">
  <div class="panel-body">

    <p>Enter any <a href="https://www.ncbi.nlm.nih.gov/pubmed/">PubMed</a> search above to see how your results change over time. PubMed by Year shows your search <em>proportionally</em>, allowing you to discover publication trends by comparing results for each year to the database as whole.</p>
    <p>You can use one word (e.g. <code><a class="example" data-srchstr="q1=heart">heart</a>, <a class="example" data-srchstr="q1=diabetes">diabetes</a></code>) or
    several (<code><a class="example" data-srchstr="q1=breast cancer">breast cancer</a>, <a class="example" data-srchstr="q1=myocardial infarction">myocardial infarction</a></code>).</p>
    <p>You can even use more advanced techniques such as field tags (<code><a class="example" data-srchstr="Leukemia[Mesh]">Leukemia[Mesh]</a>, <a class="example" data-srchstr="q1=pubmednotmedline [sb]">pubmednotmedline [sb]</a></code>) or
    boolean operators (<code><a class="example" data-srchstr="q1=smoking AND lung cancer ">smoking AND lung cancer</a>, <a class="example" data-srchstr="q1=polio AND (vaccine OR vaccination)">polio AND (vaccine OR vaccination)</a></code>).</p>

    <p>Finally, by entering multiple searches one at a time, you can <code><a class="example" data-srchstr="q1=dengue&q2=chikungunya&q3=zika">compare</a></code> them directly to one another.
    Once you're finished, you can easily share your results with others by sending them a link to your search or by saving your graphs (or CSV data) for later.</p>

      <em><a href="about.html">(more details)</a></em></p>
    </div>
</div>
</div>
</div>

</div><!--row-->


<!--
<div class="col-sm-12 col-md-2 col-lg-3">

<div id="past" class="panel panel-default hideme">
  <div class="panel-heading">
    <h3 class="panel-title">Past searches</h3>
  </div>
  <div class="panel-body">
  </div>
</div>
-->

<div id="sharing-link" class="modal fade" tabindex="-1" role="dialog" aria-labelledby="myLargeModalLabel">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
        <h4 class="modal-title">Share this search</h4>
      </div>
      <div class="modal-body">
        <input type="text" id="sharingUrlcontent">
      </div>
      <div class="modal-footer">
        <button type="button" class="copyme">Copy link to clipboard</button>
      </div>
    </div>
  </div>
</div>

<div id="printchart" class="modal modal-wide fade" tabindex="-1" role="dialog" aria-labelledby="myLargeModalLabel">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
        <h4 class="modal-title">Printable Chart</h4>
      </div>
      <div class="modal-body">
        <canvas id="canvas"></canvas>
      </div>
      <div class="modal-footer">
        <p>Right click on image to save</p>
        <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
        <button type="button" id="changesize" class="btn btn-primary">View Larger Size</button>
      </div>
    </div>
  </div>
</div>

<p style='clear: both; margin-bottom: 60px;'></p>
<br />

</div>

<!--
</div>
</div>
-->


<!-- START Bootstrap-Cookie-Alert
<div class="alert text-center cookiealert" role="alert">
    <b>Do you like cookies?</b> &#x1F36A; We use cookies to ensure you get the best experience on our website. <a href="https://cookiesandyou.com/" target="_blank">Learn more</a>

    <button type="button" class="btn btn-primary btn-sm acceptcookies">
        I agree
    </button>
</div>
END Bootstrap-Cookie-Alert -->

<footer class="footer">
  <div class="container">
    <span class="text-muted">  <p>Design and contruction by Ed Sperr, M.L.I.S. (<a href="mailto:ed_sperr@hotmail.com">ed_sperr@hotmail.com</a>)   |
      Data from <a href="http://www.ncbi.nlm.nih.gov/">NCBI</a>  |   Charting tools from  <a href="https://developers.google.com/chart/interactive/docs/gallery/linechart" target="_blank">Google</a>
     | See the code at <a href="https://github.com/esperr/pubmed-by-year">GitHub</a></p></span>
  </div>
</footer>


<script>

(function() {

var searches = { counts:{}, searchterms:[] };
var dataURL = "";
var basecounts = {};

var d = new Date();
//What was the year 30 days ago?
d.setDate(d.getDate()-30);
var endYear = d.getFullYear();
var thisYear = endYear;

var startYear = 1945;

var data;
var options;

var printsize = "small";

var currentLocation = location.hostname + location.pathname;

//Fetch our baseline counts from the webservice
$.get( "https://med-by-year.appspot.com/showbasecounts", function( data ) {
  //build out our data structure
  var allCounts = data.counts;
  for (var year in allCounts) {
    searches.counts[year] = { "total": allCounts[year] } ;
  }
  pickYears();
  if (location.search) {
    var queryDict = {};
    location.search.substr(1).split("&").forEach(function(item) {
        queryDict[item.split("=")[0]] = item.split("=")[1]
    })
    if (queryDict["startyear"]) { startYear = queryDict["startyear"]; }
    if (queryDict["endyear"]) { endYear = queryDict["endyear"]; }
    for (var search in queryDict) {
      if(search.match(/q/)) {
        term = decodeURIComponent(queryDict[search])
        dosearch(term);
      }
    }
  }
})
.fail(function() {
  alert( "There was some sort of problem -- please reload the page" );
});

//var search = [];
google.charts.load('current', {'packages':['line']});


var currentwidth = $("#left").innerWidth() * .9;
var mywidth = 600;
var myheight = 300;
if (currentwidth > mywidth) {
  mywidth = currentwidth;
  myheight = currentwidth*.5;
}

//manually get baseline counts
//term = "all[sb]";
//dosearch(term);
//alert("done!");

//Do we have a search or datespan specified in the querystring?

function handlesearch() {
  term = $("#pmsearch").val();
  dosearch(term);
  $("#pmsearch").val("");
  document.getElementById('pmsearch').focus();
  }


  window.onpopstate = function(event) {
    //reconstitute earlier searches if the user is going "back"
    if (event.state) {
      searches = event.state["myData"];
      startYear = event.state["startyear"];
      endYear = event.state["endyear"];
      drawMainChart();
    }
  };

function showWait() {
  $( "#pmsearch" ).prop( "disabled", true );
  $( "#runsearch" ).prop( "disabled", true );
  $( "form" ).addClass( "hideme" );
  $("#results").empty();
  $( "#results" ).append("<div id='loading'><p class='text-center'>Grabbing your results &mdash; please wait</p></div>")
  $( "#results p" ).append( '<br /><img src="loading-bars.svg">' );
  }

  function showDone() {
    $( "#pmsearch" ).prop( "disabled", false );
    $( "#runsearch" ).prop( "disabled", false );
    $( "form" ).removeClass( "hideme" );
    $( "#runsearch" ).removeClass( "hideme" );
    $("#loading").remove();
    $("#fetchresults").remove();
    }

  function pickYears() {
    $("#pickyears").empty();
    $("#pickyears").append('Start: <select name="startyear">');
    $("#pickyears").append('&nbsp;&nbsp;End: <select name="endyear">');
    for (var year in searches.counts) {
      if (Number(year) < 1600) { continue; }
      if (Number(year) < endYear) {
        if (year == startYear) {
          $("[name=startyear]").append('<option value="' + year + '" selected="selected">' + year + '</option>');
        } else {
          $("[name=startyear]").append('<option value="' + year + '">' + year + '</option>');
        }
      }
      if (Number(year) > startYear) {
        if (year == endYear) {
          $("[name=endyear]").append('<option value="' + year + '" selected="selected">' + year + '</option>');
        } else {
          $("[name=endyear]").append('<option value="' + year + '">' + year + '</option>');
        }
      }
    }
  }

$(".example").click(function(){
    var searchstr = $( this ).attr("data-srchstr");
     window.open(location.pathname + "?" + searchstr);
    });

$( "#results" ).on( "click", ".printMe", function() {
    getprint();
    });

$( "#results" ).on( "click", ".shareLink", function() {
    $('#sharing-link').modal();
    });

  $( "#pickyears" ).on( "change", "[name=startyear]", function() {
    startYear = Number($("[name=startyear]").val());
    pickYears();
    if (searches.searchterms.length > 0) {
        drawMainChart();
    }
  });

  $( "#pickyears" ).on( "change", "[name=endyear]", function() {
    endYear = Number($("[name=endyear]").val());
    pickYears();
    if (searches.searchterms.length > 0) {
      drawMainChart();
    }
  });

  $( "#results" ).on( "click", "#reset", function() {
    //var currentLocation = location.hostname + location.pathname;
    //alert (currentLocation);
    location.replace(location.pathname);
  });

  $( "#changesize" ).click(function() {
    if ( printsize == "small" ) {
      printsize = "large";
    } else {
      printsize = "small";
    }
    getprint();
  });

function dosearch(term) {
  showWait();
  urlstem = "https://med-by-year.appspot.com/newsearch?q=";
  url = urlstem + encodeURIComponent(term);
  $.get( url, function( data ) {
    if (data.hasOwnProperty('counts')) {
      searches.searchterms.push(term);
      myCounts = data.counts;
      for (var year in myCounts) {
        searches.counts[year][term] = myCounts[year];
      }
      drawMainChart();
    } else {
      showDone();
      getTotals(term);
      $("#results").append('<div id="noJoy" class="alert alert-warning alert-danger" role="alert">');
      $("#results .alert").append('<button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">&times;</span></button>');
      $("#results .alert").append('<h4>Sorry!&nbsp;</h4>');
      $("#results .alert").append("<p><div id=noJoymsg></div></p>");
      //'alert("Nothing found for this search or too few results to chart by year. Please try again");
      $('#noJoy').on('closed.bs.alert', function () {
        if (searches.searchterms.length > 0) {
          console.log(JSON.stringify(searches))
            drawMainChart();
        } else {
          return;
        }
      })
    }
  })
  .fail(function() {
    alert( "There was some sort of problem -- please reload the page" );
  });
  }

function getTotals(term) {
  //Grab NCBI counts to see what's going on if we don't have a CSV file
  $.get( "https://eutils.ncbi.nlm.nih.gov/entrez/eutils/esearch.fcgi?db=pubmed&retmode=json&rettype=count&term=" + term, function( data ) {
    var totalCount = data.esearchresult.count;
    var tryagainURL = 'https://www.ncbi.nlm.nih.gov/pubmed/?term=' + term;
    if (totalCount == 0) {
      console.log("nothing!");
      $("#noJoymsg").append('Nothing was found for this search. Try something else above or see if you can <a href="' + tryagainURL + '">refine your strategy on PubMed</a>');
    } else {
      $("#noJoymsg").append('Your search only retrieved <strong>' + totalCount + '</strong> results. PubMed by Year can only graph searches that have at least 500 results in total.');
      $("#noJoymsg").append('Try something else above or see if you can <a href="' + tryagainURL + '">refine your strategy on PubMed</a>');
    }
  })
  .fail(function() {
    alert( "There was some sort of problem -- please reload the page" );
  });
}

$("#runsearch").click(function(){
    handlesearch();
  });

 $(document).keypress(function(e) {
  if(e.which == 13) {
      //Because both IE and FF now "helpfully" ignore the spec and treat 'button' the same as 'submit'
      e.preventDefault();
      handlesearch();
  }
});



function drawMainChart() {
  var CSVvalues = [];
  $("#results").empty();
  showDone();
  if (startYear < 1945) {
    $("#results").append('<div class="alert alert-warning" role="alert">');
    $("#results .alert").append('<strong>Remember:</strong> OLDMEDLINE only goes back to 1946, so results are sparse before then');
  }
  $("#results").append('<p>Search again above to compare results on your chart. Choose "Reset Searches" below to start over.</p>');
  $("#results").append('<p>Hover to see details for a given year. Click to launch a search in PubMed</p>');

  $( "#results" ).append( '<div class="panel panel-default">' );
  $( "#results .panel" ).append( '<div id="chart_div" class="panel-body">' );
  //"hidden" div where we draw the printable chart
  $( "#results" ).append( '<div id="chart_two">' );
  $("#results .panel").after('<button id="reset" type="button" class="btn btn-warning">Reset Searches</button>');

  var myQuerystring = "";
  //var queryDict = {};
  for (i=0; i<searches.searchterms.length; i++) {
    if (myQuerystring.length > 0) { myQuerystring = myQuerystring + "&"; }
    var qindex = i+1;
    //queryDict['q' + qindex.toString()] = searches.searchterms[i];
    var querypart = 'q' + qindex.toString() + '=' + searches.searchterms[i];
    myQuerystring = myQuerystring + querypart;
  }
  if (startYear != 1945) {
    myQuerystring = myQuerystring + "&startyear=" + startYear;
    //queryDict["startyear"] = startYear;
  }
  if (endYear != thisYear) {
    myQuerystring = myQuerystring + "&endyear=" + endYear;
    //queryDict["endyear"] = endYear;
  }
  var shareUrl = "https://" + currentLocation + "?" +  pastyString(myQuerystring);
  $( "#sharingUrlcontent" ).attr( "style", "width: 35em;" );
  $( "#sharingUrlcontent" ).attr( "value", shareUrl );

  data = new google.visualization.DataTable();
  var CSVlabels = [];
  data.addColumn('string', 'Year');
  CSVlabels[0] = "Year";
  for (i = 0; i < searches.searchterms.length; i++) {
    data.addColumn('number', searches.searchterms[i]);
    CSVlabels[i+1] = searches.searchterms[i];
  }
  CSVvalues.push(CSVlabels);

  for (var year in searches.counts) {
    if (Number(year) < startYear) { continue; }
    if (Number(year) > endYear) { continue; }
    theseCounts = [year];
    var CSVcounts = [year];
    for (i = 0; i < searches.searchterms.length; i++) {
      var term = searches.searchterms[i];
      var yearTotal = Number(searches.counts[year]["total"]);
      if (searches.counts[year][term]) {
        var proportion = (Number(searches.counts[year][term]) / yearTotal) * 100000;
        construct = {
          v: proportion,
          f: Number(searches.counts[year][term]).toLocaleString() + " citations (out of " + yearTotal.toLocaleString() + " in " + year + ")"
        }
        theseCounts.push(construct);
        CSVcounts[i+1] = proportion;
        //theseCounts.push(proportion);
      } else {
        theseCounts.push(0);
        CSVcounts[i+1] = 0;
      }
    }
    data.addRow(theseCounts);
    CSVvalues.push(CSVcounts);
  }
  //we clear the address bar...
  var ourLocation = location.pathname + "?" + myQuerystring;
  history.pushState({ "myData": searches, "startyear": startYear, "endyear": endYear }, "No real title here", ourLocation);


  options = {
        chart: {
          title: 'Results per 100,000 citations in PubMed',
          subtitle: 'proportion for each search by year, ' + $("[name=startyear]").val() + ' to ' + $("[name=endyear]").val()
        },
        width: mywidth,
        height: myheight,
        vAxis: {format: 'decimal',
                title: 'results per 100,000'},
      };

  var chart = new google.charts.Line(document.getElementById('chart_div'));

  //Here comes the clicky bit...
  function selectHandler() {
  var selectedItem = chart.getSelection()[0];
  if (selectedItem) {
    var year = data.getValue(selectedItem.row, 0);
    var thisSearchindex = selectedItem['column'];
    var myterm = searches.searchterms[thisSearchindex-1];
    var resultsURL = 'https://www.ncbi.nlm.nih.gov/pubmed/';
    resultsURL = resultsURL + '?term=' + myterm + '+AND+' + year + '[DP]';
    window.open(resultsURL,'_blank');
   }
  }

  google.visualization.events.addListener(chart, 'select', selectHandler);
  chart.draw(data,  google.charts.Line.convertOptions(options));
  google.visualization.events.addListener(chart, 'ready', downloadHandler);
  var CSVtext = "";
  for (i=0;i<CSVvalues.length;i++) {
    CSVtext += CSVvalues[i].toString() + '\n';
  }
  var CSVdata = 'data:text/csv;charset=utf-8,' + encodeURI(CSVtext);


  function downloadHandler() {
    var t = $("#chart_div svg")[0];
    var xmlString = (new XMLSerializer).serializeToString(t);
    var dataLink = "data:image/svg+xml," + encodeURIComponent(xmlString);

    $("#svgdownload").attr("href", dataLink);
    $("#csvdownload").attr("href", CSVdata);
  }

  $("#chart_div").append('<div id="bug" class="panel panel-default">');
  $("#chart_div #bug").append('<a href="#!" class="printMe">Printable version</a><br />');
  $("#chart_div #bug").append('Download: <a href="" id="csvdownload" download="PubMed by Year.csv">CSV data</a> | <a href="" id="svgdownload" download="PubMed by Year.svg">SVG for chart</a><br />');
  $("#chart_div #bug").append('Share this search: <a href="#!" class="shareLink">Link</a>');

  }

  function getprint() {
    //$( "#printable img" ).remove();
    $("#chart_two").removeClass( "hideme" );
    if (printsize == "small") {
      width = 600;
      height = 300;
      $("canvas").attr("width", "600");
      $("canvas").attr("height", "330");
      $("#printchart").removeClass("modal-wide");
      $("#printchart").addClass("modal-medium");
      $("#changesize").text("Larger size");
    }
    if (printsize == "large") {
      width = 1200;
      height = 600;
      $("canvas").attr("width", "1200");
      $("canvas").attr("height", "630");
      $("#printchart").removeClass("modal-medium");
      $("#printchart").addClass("modal-wide");
      $("#changesize").text("Smaller size");
    }
    var charttwo = new google.charts.Line(document.getElementById('chart_two'));
    options.width = width;
    options.height = height;
    charttwo.draw(data,  google.charts.Line.convertOptions(options));
    google.visualization.events.addListener(charttwo, 'ready', myReadyHandler);

    function myReadyHandler() {
      var t = $("#chart_two svg")[0];
      var xmlString = (new XMLSerializer).serializeToString(t);
      var canvchart = document.createElement("canvas");
      canvg(canvchart, xmlString, { log: true, ignoreMouse: true, ignoreAnimation: true });
      var c2 = document.createElement("canvas");
      c2.width = width;
      c2.height = height + 40;
      var ctx = c2.getContext('2d');
      ctx.beginPath();
      ctx.rect(0, 0, width, height + 40);
      ctx.fillStyle = "white";
      ctx.fill();
      ctx.font="13px Roboto";
      ctx.fillStyle = "Gray";
      ctx.fillText("Made with PubMed by Year: http://esperr.github.io/pubmed-by-year",25,height);

      //var can = document.getElementById('canvas');
      var can3 = document.getElementById('canvas');
      var ctx3 = can3.getContext('2d');

      ctx3.drawImage(c2, 0, 0);
      ctx3.drawImage(canvchart, 25, 25, width-50, height-50);
      var newdataURL = c2.toDataURL();
      $("#chart_two").addClass( "hideme" );
      $('#printchart').modal();
      //$("#printable").css("display", "block");
    }

    }

$(".close").click(function(){
  $("#printable").css("display", "none");
      });

$(document).click(function(event) {
   var closeit = document.getElementById('printable');
   if (event.target == closeit) {
      $("#printable").css("display", "none");
      }
      });

function keysrt(arr, key, reverse) {
    var sortOrder = 1;
    if(reverse){
        sortOrder = -1;
    }
    return arr.sort(function(a, b) {
        var x = a[key],
            y = b[key];

        return sortOrder * ((x < y) ? -1 : ((x > y) ? 1 : 0));
    });
}

function pastyString(str) {
  let pastableStr = encodeURI(str);
  pastableStr = pastableStr.replace(/\(/g, "%28");
  pastableStr = pastableStr.replace(/\)/g, "%29");
  pastableStr = pastableStr.replace(/\//g, "%2F");
  return pastableStr;
}

$(".cookiealert").click(function(){
  cookiemonster();
      });

function cookiemonster() {
  $( ".cookiealert" ).hide();
}

$(".copyme").click(function(){
  let myLink = document.getElementById("sharingUrlcontent").value;
  navigator.clipboard.writeText(myLink);
  $("#sharing-link").modal('hide');
      });
})

();




</script>
</body>
</html>
